
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Interface</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

  <style>
    html, body { height: 100%; }
    #app-loader {
      position: fixed;
      inset: 0;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
  </style>
</head>

<body class="bg-white text-slate-800 overflow-hidden">

<!-- LOADER -->
<div id="app-loader">
  <div class="text-center">
    <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
    <p class="mt-3 text-sm">Initializing AI Interface...</p>
  </div>
</div>

<!-- APP -->
<div id="app" class="h-screen w-full flex flex-col opacity-0 transition-opacity duration-300">

  <header class="p-4 border-b text-center font-semibold">
    AI Interface
  </header>

  <main id="chat-container" class="flex-1 overflow-y-auto p-4">
    <div id="messages" class="max-w-3xl mx-auto space-y-4"></div>
  </main>

  <footer class="p-4 border-t">
    <div class="max-w-3xl mx-auto flex gap-2">
      <textarea id="user-input"
        class="flex-1 border rounded-lg p-2 resize-none"
        rows="1"
        placeholder="Type a message..."
        onkeydown="app.handleEnter(event)">
      </textarea>
      <button onclick="app.sendMessage()"
        class="bg-blue-600 text-white px-4 rounded-lg">
        Send
      </button>
    </div>
  </footer>
</div>

<script>
const $ = (id) => document.getElementById(id);

const app = {
  state: {
    apiKey: "",
    model: "deepseek/deepseek-r1:free",
    chats: [],
    currentChatId: null
  },

  init() {
    // SAFE localStorage load
    let saved = {};
    try {
      saved = JSON.parse(localStorage.getItem("ai_state")) || {};
    } catch {
      localStorage.removeItem("ai_state");
    }
    this.state = { ...this.state, ...saved };

    // remove loader safely
    setTimeout(() => {
      const loader = $("app-loader");
      if (loader) loader.remove();
      $("app").style.opacity = "1";
    }, 300);
  },

  save() {
    localStorage.setItem("ai_state", JSON.stringify(this.state));
  },

  handleEnter(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      this.sendMessage();
    }
  },

  append(role, content) {
    const div = document.createElement("div");
    div.className = role === "user" ? "text-right" : "text-left";
    div.innerHTML = `
      <div class="inline-block max-w-[80%] p-3 rounded-lg ${
        role === "user"
          ? "bg-blue-100"
          : "bg-slate-100"
      }">
        ${role === "assistant" ? marked.parse(content) : content}
      </div>`;
    $("messages").appendChild(div);
    $("chat-container").scrollTop = $("chat-container").scrollHeight;
  },

  async sendMessage() {
    const input = $("user-input");
    const text = input.value.trim();
    if (!text) return;

    input.value = "";
    this.append("user", text);

    if (!this.state.apiKey) {
      this.append("assistant", "⚠️ Please add your API key in code.");
      return;
    }

    try {
      const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${this.state.apiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: this.state.model,
          messages: [{ role: "user", content: text }]
        })
      });

      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content || "No response";
      this.append("assistant", reply);

    } catch (err) {
      this.append("assistant", "❌ API Error");
    }
  }
};

document.addEventListener("DOMContentLoaded", () => app.init());
</script>

</body>
</html>   
